{% extends 'base.html' %}

{% block content %}
<div id="renderedContent">
    <div class="d-flex flex-column gap-1">
        <div class="d-flex justify-content-between align-items-center">
            <p class="h5 mb-0">{{ note.title }}</p>
            <button id="editButton" class="btn btn-primary btn-sm">Edit</button>
        </div>
        <div id="markdown" class="border p-2"></div>
    </div>
</div>
<form id="editNote" action="{{ url_for('notes.update_note', note_id=note.id) }}" method="POST" class="mt-3" style="display: none;">
    <div class="mb-2">
        <input type="text" name="title" class="form-control" value="{{ note.title }}" required>
    </div>
    <input type="hidden" name="content" id="editContent" required>
    <div id="editEditor" class="editor" contenteditable="plaintext-only">{{ note.content }}</div>
    <div class="mt-3">
        <button type="submit" class="btn btn-primary btn-sm">Save Changes</button>
        <a class="btn btn-danger btn-sm" href="{{ url_for('notes.delete_note', note_id=note.id) }}">Delete</a>
        <a class="btn btn-secondary btn-sm" href="{{ url_for('notes.detail', note_id=note.id) }}">Cancel</a>
    </div>
</form>

<script src="//cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    document.execCommand('defaultParagraphSeparator', false, 'p');

    const noteContent = `{{ note.content | safe }}`;

    const editButton = document.getElementById('editButton');
    const editForm = document.getElementById('editNote');
    const editEditor = document.getElementById('editEditor');
    const editContentInput = document.getElementById('editContent');

    function renderMarkdown(markdown) {
        return marked.parse(markdown);
    }
    const renderedMarkdown = renderMarkdown(noteContent);
    const markdown = document.getElementById('markdown');
    markdown.innerHTML = renderMarkdown(renderedMarkdown);

    const renderedContent = document.getElementById('renderedContent');
    editButton.onclick = function () {
        renderedContent.style.display = 'none';

        editForm.style.display = 'block';
        editEditor.innerHTML = noteContent;
        editEditor.focus();
    };

    editForm.onsubmit = function () {
        editContentInput.value = editEditor.innerHTML;
        if (!editContentInput.value.trim()) {
            alert("Content is required!");
            return false;
        }
    };
</script>
{% endblock %}
